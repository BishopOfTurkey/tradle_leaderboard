<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradle Leaderboard</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f8fafc;
            color: #374151;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* IEA-style header */
        .header {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 50%, #115e59 100%);
            color: white;
            padding: 2.5rem 2rem;
            margin-bottom: 2rem;
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .header-accent {
            display: inline-block;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #a78bfa, #34d399);
            border-radius: 2px;
            margin-bottom: 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem 3rem;
            flex: 1;
        }

        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .card h2 {
            font-size: 1.375rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card h2::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 1.25em;
            background: linear-gradient(180deg, #0d9488, #34d399);
            border-radius: 2px;
        }

        .accent-teal { color: #0d9488; }
        .accent-purple { color: #7c3aed; }
        .accent-green { color: #059669; }

        .btn {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(13, 148, 136, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(13, 148, 136, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9375rem;
            resize: vertical;
            min-height: 140px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12);
        }

        .message {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-top: 1.25rem;
            font-weight: 500;
        }

        .message.success {
            background-color: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background-color: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        code {
            background-color: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        input[type="text"] {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9375rem;
        }

        .leaderboard-table th {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background-color 0.15s;
        }

        .leaderboard-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .leaderboard-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .leaderboard-table th:hover {
            background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
        }

        .leaderboard-table th.sorted-asc::after {
            content: ' â–²';
            font-size: 0.7rem;
            color: #0d9488;
        }

        .leaderboard-table th.sorted-desc::after {
            content: ' â–¼';
            font-size: 0.7rem;
            color: #0d9488;
        }

        .leaderboard-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .leaderboard-table tbody tr {
            transition: background-color 0.15s;
        }

        .leaderboard-table tbody tr:hover {
            background-color: #f8fafc;
            cursor: pointer;
        }

        .leaderboard-table tbody tr:last-child td {
            border-bottom: none;
        }

        .leaderboard-table .rank {
            font-weight: 700;
            font-size: 1rem;
            width: 3rem;
        }

        .leaderboard-table .player-name {
            font-weight: 600;
            color: #0f172a;
        }

        .leaderboard-table .stat {
            font-variant-numeric: tabular-nums;
            color: #475569;
        }

        .leaderboard-table .gold {
            color: #f59e0b;
            text-shadow: 0 0 1px rgba(245, 158, 11, 0.3);
        }
        .leaderboard-table .silver {
            color: #64748b;
        }
        .leaderboard-table .bronze {
            color: #d97706;
        }

        .label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.5rem;
            font-size: 0.9375rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        /* Footer */
        .footer {
            background-color: #0f172a;
            color: #94a3b8;
            padding: 2rem;
            text-align: center;
            font-size: 0.875rem;
            margin-top: auto;
        }

        .footer a {
            color: #34d399;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Player detail modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }

        .game-result {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .game-result:last-child {
            margin-bottom: 0;
        }

        .game-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .game-number {
            font-weight: 600;
            color: #0f172a;
        }

        .game-score {
            font-weight: 700;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .game-score.solved {
            background: #dcfce7;
            color: #166534;
        }

        .game-score.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .game-grid {
            font-size: 1.25rem;
            line-height: 1.4;
            letter-spacing: 0.05em;
        }

        .game-date {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        .player-stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Tab styles */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9375rem;
            font-family: inherit;
            position: relative;
            transition: color 0.15s;
        }

        .tab:hover {
            color: #0d9488;
        }

        .tab.active {
            color: #0d9488;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #0d9488, #34d399);
        }

        /* Results table styles */
        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.875rem;
        }

        .results-table th {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }

        .results-table th:first-child {
            text-align: left;
            border-radius: 8px 0 0 0;
        }

        .results-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .results-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }

        .results-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #0f172a;
        }

        .results-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .result-cell {
            font-weight: 500;
        }

        .result-cell.solved {
            color: #059669;
        }

        .result-cell.failed {
            color: #dc2626;
        }

        .result-cell.empty {
            color: #cbd5e1;
        }

        .stat-box {
            text-align: center;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stat-box .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0d9488;
        }

        .stat-box .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .header {
                padding: 2rem 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 0 1rem 2rem;
            }

            .card {
                padding: 1.5rem;
            }

            .leaderboard-table {
                font-size: 0.8125rem;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div x-data="tradleApp()" x-init="init()">
        <header class="header">
            <div class="header-content">
                <div class="header-accent"></div>
                <h1>Tradle Leaderboard</h1>
                <p class="subtitle">Track your Tradle scores and compete with friends</p>
            </div>
        </header>

        <div class="container">
        <!-- Loading state -->
        <div x-show="loading" class="card">
            <p style="color: #6b7280;">Loading...</p>
        </div>

        <!-- No access state -->
        <div x-show="!loading && !dataId" class="card">
            <h2>Access Required</h2>
            <p style="color: #6b7280;">You need an invite link to access this leaderboard. The link should contain an id parameter (e.g., <code>?id=abc123</code>).</p>
        </div>

        <!-- Main content when authenticated -->
        <template x-if="!loading && dataId">
            <div>
                <div class="card">
                    <h2>Submit Your Score</h2>
                    <div class="form-group">
                        <label class="label" for="playerName">Your Name</label>
                        <input type="text" id="playerName" x-model="playerName" @change="savePlayerName()" placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label class="label" for="scoreInput">Tradle Result</label>
                        <textarea
                            id="scoreInput"
                            x-model="scoreInput"
                            placeholder="#Tradle #1419 5/6
ðŸŸ©â¬œâ¬œâ¬œâ¬œ
ðŸŸ©ðŸŸ©ðŸŸ¨â¬œâ¬œ
ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©â¬œ
ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ¨
ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©
https://oec.world/en/games/tradle"></textarea>
                    </div>
                    <div>
                        <button class="btn" @click="submitScore()" :disabled="!playerName.trim()">Submit Score</button>
                    </div>
                    <div x-show="message" class="message" :class="messageType" x-text="message"></div>
                </div>

                <div class="card">
                    <h2>Leaderboard</h2>
                    <div x-show="scores.length === 0">
                        <p style="color: #6b7280;">No scores yet. Submit your first Tradle result!</p>
                    </div>
                    <div x-show="scores.length > 0">
                        <div class="tabs">
                            <button class="tab" :class="{ active: activeTab === 'standings' }" @click="activeTab = 'standings'">Standings</button>
                            <button class="tab" :class="{ active: activeTab === 'results' }" @click="activeTab = 'results'">Results</button>
                        </div>

                        <!-- Standings Tab -->
                        <div x-show="activeTab === 'standings'">
                            <table class="leaderboard-table">
                                <thead>
                                    <tr>
                                        <th @click="sortBy('rank')">#</th>
                                        <th @click="sortBy('player')" :class="getSortClass('player')">Player</th>
                                        <th @click="sortBy('avgScore')" :class="getSortClass('avgScore')">Avg Score</th>
                                        <th @click="sortBy('totalPoints')" :class="getSortClass('totalPoints')">Points</th>
                                        <th @click="sortBy('winRate')" :class="getSortClass('winRate')">Win %</th>
                                        <th @click="sortBy('gamesPlayed')" :class="getSortClass('gamesPlayed')">Games</th>
                                        <th @click="sortBy('streak')" :class="getSortClass('streak')">Streak</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(entry, index) in leaderboard" :key="entry.player">
                                        <tr @click="selectedPlayer = entry.player">
                                            <td class="rank" :class="{'gold': index === 0, 'silver': index === 1, 'bronze': index === 2}" x-text="index + 1"></td>
                                            <td class="player-name" x-text="entry.player"></td>
                                            <td class="stat" x-text="entry.avgScore.toFixed(2)"></td>
                                            <td class="stat" x-text="entry.totalPoints"></td>
                                            <td class="stat" x-text="entry.winRate.toFixed(0) + '%'"></td>
                                            <td class="stat" x-text="entry.gamesPlayed"></td>
                                            <td class="stat" x-text="entry.streak"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <!-- Results Tab -->
                        <div x-show="activeTab === 'results'">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Round</th>
                                        <template x-for="player in allPlayers" :key="player">
                                            <th x-text="player"></th>
                                        </template>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="round in roundsTable" :key="round.gameNumber">
                                        <tr>
                                            <td x-text="'#' + round.gameNumber"></td>
                                            <template x-for="player in allPlayers" :key="player">
                                                <td class="result-cell"
                                                    :class="{
                                                        'solved': round.results[player] && round.results[player].solved,
                                                        'failed': round.results[player] && !round.results[player].solved,
                                                        'empty': !round.results[player]
                                                    }"
                                                    x-text="round.results[player] ? (round.results[player].solved ? round.results[player].score + '/6' : 'X/6') : '-'">
                                                </td>
                                            </template>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Player Detail Modal -->
                <template x-if="selectedPlayer">
                    <div class="modal-overlay" @click.self="selectedPlayer = null" @keydown.escape.window="selectedPlayer = null">
                        <div class="modal" x-data="{ details: getPlayerDetails(selectedPlayer) }">
                            <div class="modal-header">
                                <h3 x-text="selectedPlayer"></h3>
                                <button class="modal-close" @click="selectedPlayer = null">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="player-stats-summary">
                                    <div class="stat-box">
                                        <div class="stat-value" x-text="details.avgScore.toFixed(2)"></div>
                                        <div class="stat-label">Avg Score</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-value" x-text="details.totalPoints"></div>
                                        <div class="stat-label">Total Points</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-value" x-text="details.winRate.toFixed(0) + '%'"></div>
                                        <div class="stat-label">Win Rate</div>
                                    </div>
                                </div>
                                <template x-for="result in details.results" :key="result.gameNumber">
                                    <div class="game-result">
                                        <div class="game-result-header">
                                            <span class="game-number" x-text="'Game #' + result.gameNumber"></span>
                                            <span class="game-score" :class="result.solved ? 'solved' : 'failed'" x-text="result.solved ? result.score + '/6' : 'X/6'"></span>
                                        </div>
                                        <div class="game-grid" x-text="extractGrid(result.raw)"></div>
                                        <div class="game-date" x-text="formatDate(result.timestamp)"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>
        </div>

        <footer class="footer">
            <p>Tradle Leaderboard &bull; For <a href="https://oec.world/en/games/tradle" target="_blank" rel="noopener">Tradle</a></p>
        </footer>
    </div>

    <script>
        function tradleApp() {
            return {
                scoreInput: '',
                message: '',
                messageType: 'success',
                dataId: null,
                scores: [],
                loading: true,
                playerName: '',
                sortField: 'totalPoints',
                sortDirection: 'desc',
                selectedPlayer: null,
                activeTab: 'standings',

                async init() {
                    // Load player name from cookie
                    this.playerName = this.getCookie('tradlePlayerName') || '';
                    // Check URL parameter first
                    const urlParams = new URLSearchParams(window.location.search);
                    const idParam = urlParams.get('id');

                    if (idParam) {
                        // Store in cookie and use it
                        this.setCookie('tradleDataId', idParam, 365);
                        this.dataId = idParam;
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        // Check cookie
                        this.dataId = this.getCookie('tradleDataId');
                    }

                    if (this.dataId) {
                        await this.loadScores();
                    }
                    this.loading = false;
                },

                setCookie(name, value, days) {
                    const expires = new Date(Date.now() + days * 864e5).toUTCString();
                    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Strict`;
                },

                getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) {
                        return decodeURIComponent(parts.pop().split(';').shift());
                    }
                    return null;
                },

                async loadScores() {
                    try {
                        const response = await fetch(`https://api.npoint.io/${this.dataId}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.scores = data.scores || [];
                        } else if (response.status === 404) {
                            this.message = 'Invalid data ID. Please check your access link.';
                            this.messageType = 'error';
                            this.dataId = null;
                        }
                    } catch (error) {
                        console.error('Error loading scores:', error);
                        this.message = 'Failed to load scores. Please try again.';
                        this.messageType = 'error';
                    }
                },

                async saveScores() {
                    try {
                        const response = await fetch(`https://api.npoint.io/${this.dataId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ scores: this.scores })
                        });
                        return response.ok;
                    } catch (error) {
                        console.error('Error saving scores:', error);
                        return false;
                    }
                },

                savePlayerName() {
                    if (this.playerName.trim()) {
                        this.setCookie('tradlePlayerName', this.playerName.trim(), 365);
                    }
                },

                parseScore(input) {
                    const lines = input.trim().split('\n');
                    const headerMatch = lines[0].match(/#Tradle #(\d+) (\d|X)\/6/);

                    if (!headerMatch) {
                        return null;
                    }

                    const gameNumber = parseInt(headerMatch[1]);
                    const scoreRaw = headerMatch[2];
                    const score = scoreRaw === 'X' ? 7 : parseInt(scoreRaw);
                    const solved = scoreRaw !== 'X';

                    return {
                        gameNumber,
                        score,
                        solved,
                        raw: input.trim(),
                        timestamp: new Date().toISOString(),
                        player: this.playerName.trim()
                    };
                },

                get leaderboard() {
                    // Group scores by player
                    const playerStats = {};

                    for (const score of this.scores) {
                        const player = score.player || 'Anonymous';
                        if (!playerStats[player]) {
                            playerStats[player] = {
                                player,
                                scores: [],
                                totalScore: 0,
                                solvedGames: 0,
                                totalPoints: 0
                            };
                        }

                        playerStats[player].scores.push(score);
                        playerStats[player].totalScore += score.score;
                        if (score.solved) {
                            playerStats[player].solvedGames++;
                        }
                        // Points: 1/6=6pts, 2/6=5pts, 3/6=4pts, 4/6=3pts, 5/6=2pts, 6/6=1pt, X/6=0pts
                        const points = score.solved ? (7 - score.score) : 0;
                        playerStats[player].totalPoints += points;
                    }

                    // Calculate derived stats for each player
                    const leaderboardData = Object.values(playerStats).map(stats => {
                        const gamesPlayed = stats.scores.length;
                        const avgScore = gamesPlayed > 0 ? stats.totalScore / gamesPlayed : 0;
                        const winRate = gamesPlayed > 0 ? (stats.solvedGames / gamesPlayed) * 100 : 0;

                        // Calculate current streak
                        const sortedScores = [...stats.scores].sort((a, b) => b.gameNumber - a.gameNumber);
                        let streak = 0;
                        for (const s of sortedScores) {
                            if (s.solved) {
                                streak++;
                            } else {
                                break;
                            }
                        }

                        return {
                            player: stats.player,
                            avgScore,
                            totalPoints: stats.totalPoints,
                            winRate,
                            gamesPlayed,
                            streak
                        };
                    });

                    // Sort leaderboard
                    leaderboardData.sort((a, b) => {
                        let valA = a[this.sortField];
                        let valB = b[this.sortField];

                        // For avgScore, lower is better so reverse the comparison
                        if (this.sortField === 'avgScore') {
                            [valA, valB] = [valB, valA];
                        }

                        if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }

                        if (this.sortDirection === 'asc') {
                            return valA > valB ? 1 : valA < valB ? -1 : 0;
                        } else {
                            return valA < valB ? 1 : valA > valB ? -1 : 0;
                        }
                    });

                    return leaderboardData;
                },

                get allPlayers() {
                    const players = new Set();
                    for (const score of this.scores) {
                        players.add(score.player || 'Anonymous');
                    }
                    return Array.from(players).sort();
                },

                get roundsTable() {
                    // Group scores by game number
                    const rounds = {};
                    for (const score of this.scores) {
                        if (!rounds[score.gameNumber]) {
                            rounds[score.gameNumber] = {
                                gameNumber: score.gameNumber,
                                results: {}
                            };
                        }
                        const player = score.player || 'Anonymous';
                        rounds[score.gameNumber].results[player] = {
                            score: score.score,
                            solved: score.solved
                        };
                    }
                    // Sort by game number descending (most recent first)
                    return Object.values(rounds).sort((a, b) => b.gameNumber - a.gameNumber);
                },

                sortBy(field) {
                    if (this.sortField === field) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        // Default sort directions
                        if (field === 'avgScore') {
                            this.sortDirection = 'asc'; // Lower is better
                        } else if (field === 'player') {
                            this.sortDirection = 'asc'; // Alphabetical
                        } else {
                            this.sortDirection = 'desc'; // Higher is better for other stats
                        }
                    }
                },

                getSortClass(field) {
                    if (this.sortField !== field) return '';
                    return this.sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc';
                },

                getPlayerDetails(playerName) {
                    const playerScores = this.scores
                        .filter(s => s.player === playerName)
                        .sort((a, b) => b.gameNumber - a.gameNumber);

                    const leaderboardEntry = this.leaderboard.find(e => e.player === playerName);

                    return {
                        ...leaderboardEntry,
                        results: playerScores
                    };
                },

                extractGrid(raw) {
                    const lines = raw.split('\n');
                    const gridLines = lines.filter(line =>
                        line.includes('ðŸŸ©') || line.includes('ðŸŸ¨') || line.includes('â¬œ')
                    );
                    return gridLines.join('\n');
                },

                formatDate(timestamp) {
                    return new Date(timestamp).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                },

                async submitScore() {
                    if (!this.dataId) {
                        this.message = 'No access. Please use an invite link with a valid ID.';
                        this.messageType = 'error';
                        return;
                    }

                    if (!this.playerName.trim()) {
                        this.message = 'Please enter your name before submitting a score.';
                        this.messageType = 'error';
                        return;
                    }

                    const parsed = this.parseScore(this.scoreInput);

                    if (!parsed) {
                        this.message = 'Invalid Tradle score format. Please paste your complete Tradle result.';
                        this.messageType = 'error';
                        return;
                    }

                    // Check for duplicate game number by the same player
                    const existingIndex = this.scores.findIndex(
                        s => s.gameNumber === parsed.gameNumber && s.player === parsed.player
                    );
                    if (existingIndex !== -1) {
                        this.message = `You already submitted a score for Game #${parsed.gameNumber}.`;
                        this.messageType = 'error';
                        return;
                    }

                    // Add score and save
                    this.scores.push(parsed);
                    const saved = await this.saveScores();

                    if (saved) {
                        this.message = `Score recorded: Game #${parsed.gameNumber} - ${parsed.solved ? parsed.score + '/6' : 'X/6'}`;
                        this.messageType = 'success';
                        this.scoreInput = '';
                    } else {
                        // Remove the score we just added since save failed
                        this.scores.pop();
                        this.message = 'Failed to save score. Please try again.';
                        this.messageType = 'error';
                    }
                }
            }
        }
    </script>
</body>
</html>
